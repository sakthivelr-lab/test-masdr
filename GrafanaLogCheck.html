<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Grafana Call Log Parser</title>

    <style>
        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 220px;
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #334155;
            padding: 10px;
            margin-bottom: 12px;
        }

        button {
            padding: 8px 16px;
            background: #2563eb;
            border: none;
            color: white;
            cursor: pointer;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid #334155;
            padding: 6px;
            vertical-align: top;
        }

        th {
            background: #020617;
            color: #93c5fd;
        }

        tr:nth-child(even) {
            background: #020617;
        }

        .wrap {
            max-width: 260px;
            word-break: break-word;
        }

        .basic {
            background: white;
            padding: 30px;
            color: black;
            line-height: 26px;
        }

        .basic span {
            color: red;
        }

        .hidden {
            display: none;
        }

        /* Scroll buttons */
        .scroll-btn {
            position: fixed;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #111827;
            color: #fff;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            z-index: 9999;
        }

        #scrollUpBtn {
            bottom: 88px;
        }

        #scrollDownBtn {
            bottom: 20px;
        }

        .scroll-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body>

    <h2>ðŸ“ž Grafana Call Log Debugger</h2>

    <textarea id="logInput" placeholder="Paste Grafana <tbody> HTML here..."></textarea>
    <br>
    <button id="logFn" onclick="parseGrafanaHTML()">Parse Logs</button>
    <button onclick="reset()">Reset Logs</button>
    <!-- Floating scroll buttons -->
    <button id="scrollUpBtn" class="scroll-btn" title="Scroll up (dblclick = top)" aria-label="Scroll up">â–²</button>
    <button id="scrollDownBtn" class="scroll-btn" title="Scroll down (dblclick = bottom)"
        aria-label="Scroll down">â–¼</button>



    <div id="loader" class="hidden">
        <p>Loading....</p>
    </div>
    <div>
        <h1>Basic Info About call</h1>
        <p class="basic" id="basicInfo"></p>
    </div>



    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Date Time</th>
                <th>Date Time diff</th>
                <th>Local User JID</th>
                <th>Interaction ID</th>
                <th>Role</th>
                <th>User Domain</th>
                <th>Message</th>
                <th>Room ID</th>
                <th>Remote User JID</th>
                <th>Data</th>
                <th>entrieLog Text</th>
            </tr>
        </thead>
        <tbody id="result"></tbody>
    </table>

    <script>

        function showLoader() {
            loader = true;
            document.getElementById("loader")?.classList.remove("hidden");
        }

        function hideLoader() {
            loader = false;
            document.getElementById("loader")?.classList.add("hidden");
        }

        let loader = false;

        hideLoader();
        let localStorageData = localStorage.getItem("log");

        if (localStorageData) {
            localStorageData = JSON.parse(localStorageData);
            document.getElementById("logInput").innerHTML = localStorageData;
        };

        function reset() {
            loader = false;
            document.getElementById("loader").style.display = "none"
            localStorage.clear();
            document.getElementById("logInput").innerHTML = "";
            document.getElementById("logInput").value = "";
            document.getElementById("result").innerHTML = ""
        }
    </script>

    <!-- Additional global scroll handlers: click = page, dblclick = full top/bottom -->
    <script>
        (function () {
            function pageUp() {
                try { window.scrollBy({ top: -window.innerHeight, left: 0, behavior: 'smooth' }); }
                catch (e) { window.scrollTo(0, Math.max(0, window.scrollY - window.innerHeight)); }
            }

            function pageDown() {
                try { window.scrollBy({ top: window.innerHeight, left: 0, behavior: 'smooth' }); }
                catch (e) { window.scrollTo(0, window.scrollY + window.innerHeight); }
            }

            function toTop() {
                try { window.scrollTo({ top: 0, left: 0, behavior: 'smooth' }); }
                catch (e) { window.scrollTo(0, 0); }
            }

            function toBottom() {
                try { window.scrollTo({ top: document.documentElement.scrollHeight || document.body.scrollHeight, left: 0, behavior: 'smooth' }); }
                catch (e) { window.scrollTo(0, document.body.scrollHeight); }
            }

            const up = document.getElementById('scrollUpBtn');
            const down = document.getElementById('scrollDownBtn');

            if (up) {
                up.addEventListener('click', pageUp);
                up.addEventListener('dblclick', toTop);
            }

            if (down) {
                down.addEventListener('click', pageDown);
                down.addEventListener('dblclick', toBottom);
            }

            // Optional: show a small tooltip on dblclick behavior via title update
            if (up && up.title && !up.title.includes('dblclick')) up.title += ' (dblclick = top)';
            if (down && down.title && !down.title.includes('dblclick')) down.title += ' (dblclick = bottom)';
        })();
    </script>

    <script>


        let basicInfo = {
        }

        function cleanHTML(html) {
            const div = document.createElement("div");
            div.innerHTML = html;

            // remove <mark> but keep text
            div.querySelectorAll("mark").forEach(m => m.replaceWith(m.textContent));

            let text = div.textContent || "";
            return text.replace(/&rlm;|\u200f|\u200e/g, "");
        }

        function formatDiffTime(ms) {
            if (ms < 1000) return `${ms} ms`;
            if (ms < 60000) return `${(ms / 1000).toFixed(2)} sec`;
            return `${(ms / 60000).toFixed(2)} min`;
        }




        // FIXED: Grab full logDetails including escaped quotes
        function extractLogDetails(text) {
            const regex = /"logDetails":"((?:[^"\\]|\\.)*)"/g;
            const matches = [...text.matchAll(regex)];

            const timestampRegex = /^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+)/gm;
            const timestamps = [...text.matchAll(timestampRegex)].map(m => m[1]);

            // return matches.map((m, index) => ({
            //     logDetails: m[1],
            //     time: timestamps[index] || null,
            //     diffTime: index > 2 && timestamps[index - 1] - timestamps[index]
            // }));

            return matches.map((m, index) => {
                const current = timestamps[index]
                    ? new Date(timestamps[index]).getTime()
                    : null;

                const next = timestamps[index + 1]
                    ? new Date(timestamps[index + 1]).getTime()
                    : null;

                const diffMs =
                    current && next
                        ? Math.abs(next - current)
                        : null;

                return {
                    logDetails: m[1],
                    time: timestamps[index] || null,
                    diffTime: diffMs !== null ? formatDiffTime(diffMs) : "-"
                };
            });
        }

        function safeJSON(str) {
            try { return JSON.parse(str); } catch { return str; }
        }

        function parseLogDetails(log, time, rest) {

            console.log(log, 'loglogloglog');
            console.log('--------');


            const parts = [...log.matchAll(/\[([^\]]+)\]/g)].map(m => m[1]);

            const getJSON = (key) => {
                const m = log.match(new RegExp(`\\{\\s*"${key}"\\s*":([^}]+)\\}`));
                return m ? safeJSON(`{"${key}":${m[1]}}`)[key] : "-";
            };


            function extractValueFromLog(log, key) {
                const unescaped = log.replace(/\\"/g, '"');
                const regex = new RegExp(`\\{[^{}]*"${key}"\\s*:\\s*"([^"]+)"[^{}]*\\}`, "g");
                const match = regex.exec(unescaped);
                return match ? match[1] : "-";
            }


            const message = (() => {
                let msg = log;
                msg = msg.replace(/\\"/g, '"')
                    .replace(/\\n/g, " ")
                    .replace(/\\t/g, " ")
                    .replace(/\\\\/g, "\\");

                msg = msg.replace(/^(\[[^\]]+\]\s*){5}/, "").trim();

                msg = msg.replace(/\{(?:\\.|[^{}])*?\}/g, "").trim();

                return msg || "-";
            })()

            if (String(message).match("Calling from call component remoteCount")) {

                let user = String(parts[4] + "-" + parts[2]).trim();
                console.log("enter calll", user);
                basicInfo["Call_visited"] = [
                    ...new Set([...(basicInfo["Call_visited"] || []), user])
                ];
            }

            if (String(message).match("send endCall")) {
                let user = String(parts[4] + "---------" + parts[2]).trim();
                basicInfo["call_end_by"] = user;
            }

            if (String(message).match("Incoming Call Popup Mounted")) {
                let user = String(parts[4] + "-" + parts[2]).trim();
                basicInfo["Incoming_Call_Pop_shown"] = [
                    ...new Set([...(basicInfo["Incoming_Call_Pop_shown"] || []), user])
                ];
            }

            if (String(message).match("Answer call processing")) {
                let user = String(parts[4] + "-" + parts[2]).trim();
                basicInfo["AnswerTime"] = time;
                basicInfo["Answered_by"] = user;
            }


            if (String(message).match("send endCall") && !basicInfo["EndTime"]) {
                basicInfo["EndTime"] = time;
            }

            if (basicInfo["EndTime"] && basicInfo["AnswerTime"] && !basicInfo["Total_call_Time"]) {
                let diffMs =
                    new Date(basicInfo["EndTime"]) - new Date(basicInfo["AnswerTime"]);
                let di = formatDiffTime(Math.abs(diffMs));
                basicInfo["Total_call_Time"] = di;

                delete basicInfo.EndTime;
                delete basicInfo.AnswerTime;
            }

            return {
                title: parts[0] || "-",
                datetime: time || "inside TIME" + parts[1] || "-",
                localUserJid: parts[2] || "-",
                interactionId: parts[3] || "-",
                role: parts[4] || "-",
                userdomain: getJSON("userdomain"),
                diffTime: rest?.diffTime,
                message: message,
                roomId: extractValueFromLog(log, "roomId"),
                remoteUserjid: extractValueFromLog(log, "remoteUserjid"),
                entrieLog: log,
                remoteUserjid: (() => {
                    const match = log.match(/"remoteUserjid"\s*:\s*"([^"]+)"/);
                    return match ? match[1] : "-"
                })(),

                // remoteUserjid: getJSON("remoteUserjid"),
                data: getJSON("xmppStatus") !== "-" ? log.match(/\{.*CONNECTED.*\}/)?.[0] || "-" : "-",
                dashboardText: log.includes("dashboard") ? log.match(/"([^"]+)"$/)?.[1] || "-" : "-"
            };
        }

        async function parseGrafanaHTML() {

            try {
                if (loader) {
                    return;
                }
                showLoader()
                const input = document.getElementById("logInput").value;
                localStorage.setItem("log", JSON.stringify(input));
                const tbody = document.getElementById("result");
                tbody.innerHTML = "";
                const cleanText = cleanHTML(input);
                const logs = extractLogDetails(cleanText);

                await logs.forEach((log, index) => {
                    const { logDetails, time, ...rest } = log;

                    const d = parseLogDetails(logDetails, time, rest);

                    tbody.innerHTML += `
      <tr>
        <td>${d.title}</td>
        <td>${d.datetime}</td>
        <td>${d.diffTime}</td>
        <td class="wrap">${d.localUserJid}</td>
        <td>${d.interactionId}</td>
        <td>${d.role}</td>
        <td>${d.userdomain}</td>
        <td class="wrap">${d.message}</td>
        <td>${d.roomId}</td>
        <td class="wrap">${d.remoteUserjid}</td>
        <td class="wrap">${d.data}</td>
        <td class="wrap">${d.entrieLog}</td>
      </tr>
    `;
                });


                const htmlOutput = Object.entries(basicInfo)
                    .map(([key, value]) => {
                        // if value is array â†’ numbered list
                        if (Array.isArray(value)) {
                            const list = value
                                .map((item, index) => `${index + 1}. ${item}`)
                                .join("<br>");

                            return `<span>${key}</span> :<br>${list}`;
                        }

                        // normal key : value
                        return `<span>${key}</span> : ${value}`;
                    })
                    .join("<br>");


                document.getElementById("basicInfo").innerHTML = htmlOutput;


                hideLoader()


            } catch (error) {
                hideLoader()
            }

            // Scroll helpers: scroll one viewport up/down smoothly
            function scrollUp() {
                try {
                    window.scrollBy({ top: -window.innerHeight, left: 0, behavior: 'smooth' });
                } catch (e) {
                    // fallback
                    window.scrollTo(0, Math.max(0, window.scrollY - window.innerHeight));
                }
            }

            function scrollDown() {
                try {
                    window.scrollBy({ top: window.innerHeight, left: 0, behavior: 'smooth' });
                } catch (e) {
                    // fallback
                    window.scrollTo(0, window.scrollY + window.innerHeight);
                }
            }

            // Attach event listeners for the buttons (safe-guard if elements missing)
            document.getElementById('scrollUpBtn')?.addEventListener('click', scrollUp);
            document.getElementById('scrollDownBtn')?.addEventListener('click', scrollDown);
        }

    </script>

</body>

</html>